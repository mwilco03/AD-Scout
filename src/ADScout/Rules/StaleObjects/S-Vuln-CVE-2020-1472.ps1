<#
.SYNOPSIS
    Detects Domain Controllers potentially vulnerable to Zerologon (CVE-2020-1472).

.DESCRIPTION
    Zerologon allows an unauthenticated attacker to completely compromise a domain
    by exploiting a flaw in the Netlogon protocol. This rule checks for unpatched
    DCs and insecure Netlogon configurations.

.NOTES
    Rule ID    : S-Vuln-CVE-2020-1472
    Category   : StaleObjects
    Author     : AD-Scout Contributors
    Version    : 1.0.0
#>

@{
    Id          = 'S-Vuln-CVE-2020-1472'
    Version     = '1.0.0'
    Category    = 'StaleObjects'
    Title       = 'Zerologon Vulnerability (CVE-2020-1472)'
    Description = 'Identifies Domain Controllers potentially vulnerable to Zerologon, which allows unauthenticated domain takeover.'
    Severity    = 'Critical'
    Weight      = 100
    DataSource  = 'DomainControllers'

    References  = @(
        @{ Title = 'CVE-2020-1472 - Zerologon'; Url = 'https://msrc.microsoft.com/update-guide/vulnerability/CVE-2020-1472' }
        @{ Title = 'Zerologon Explained'; Url = 'https://www.secura.com/blog/zero-logon' }
        @{ Title = 'Microsoft Guidance'; Url = 'https://support.microsoft.com/en-us/topic/how-to-manage-the-changes-in-netlogon-secure-channel-connections-associated-with-cve-2020-1472-f7e8cc17-0309-1c6a-6571-d022e36cdcc4' }
    )

    MITRE = @{
        Tactics    = @('TA0004', 'TA0006')  # Privilege Escalation, Credential Access
        Techniques = @('T1210', 'T1003')   # Exploitation of Remote Services, Credential Dumping
    }

    CIS   = @('7.1')
    STIG  = @('V-73229')
    ANSSI = @('vuln1_zerologon')

    Scoring = @{
        Type    = 'PerDiscovery'
        PerItem = 50
    }

    Detect = {
        param($Data, $Domain)

        $findings = @()

        # Required patches for Zerologon
        # August 2020 and later patches fix CVE-2020-1472
        $patchDate = [DateTime]'2020-08-11'

        if ($Data.DomainControllers) {
            foreach ($dc in $Data.DomainControllers) {
                $dcName = $dc.Name
                if (-not $dcName) { $dcName = $dc.DnsHostName }
                if (-not $dcName) { continue }

                $vulnerabilityStatus = 'Unknown'
                $enforcementMode = 'Unknown'
                $patchStatus = 'Unknown'

                try {
                    $result = Invoke-Command -ComputerName $dcName -ScriptBlock {
                        # Check for Netlogon enforcement registry key
                        $netlogonPath = 'HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters'
                        $fullSecureMode = Get-ItemProperty -Path $netlogonPath -Name 'FullSecureChannelProtection' -ErrorAction SilentlyContinue
                        $vulnerableMode = Get-ItemProperty -Path $netlogonPath -Name 'VulnerableChannelAllowList' -ErrorAction SilentlyContinue

                        # Check last hotfix date
                        $hotfixes = Get-HotFix | Sort-Object InstalledOn -Descending | Select-Object -First 5

                        # Check Windows Update history for August 2020+ updates
                        $august2020Patches = $hotfixes | Where-Object {
                            $_.InstalledOn -ge [DateTime]'2020-08-11'
                        }

                        @{
                            FullSecureChannelProtection = $fullSecureMode.FullSecureChannelProtection
                            VulnerableChannelAllowList = $vulnerableMode.VulnerableChannelAllowList
                            RecentHotfixes = $hotfixes | Select-Object HotFixID, InstalledOn
                            HasAugust2020Patch = ($august2020Patches.Count -gt 0)
                            OSVersion = [System.Environment]::OSVersion.Version.ToString()
                        }
                    } -ErrorAction Stop

                    if ($result) {
                        # Determine enforcement mode
                        if ($result.FullSecureChannelProtection -eq 1) {
                            $enforcementMode = 'Full Enforcement (Secure)'
                        } elseif ($result.VulnerableChannelAllowList) {
                            $enforcementMode = 'Partial (Allow list configured)'
                        } else {
                            $enforcementMode = 'Not configured (check patch status)'
                        }

                        # Check patch status
                        if ($result.HasAugust2020Patch) {
                            $patchStatus = 'August 2020+ patches installed'
                        } else {
                            $patchStatus = 'May be missing critical patches'
                        }

                        # Determine vulnerability
                        if ($result.FullSecureChannelProtection -eq 1) {
                            $vulnerabilityStatus = 'Protected (enforcement enabled)'
                        } elseif ($result.HasAugust2020Patch -and -not $result.VulnerableChannelAllowList) {
                            $vulnerabilityStatus = 'Likely protected (patched, no allow list)'
                        } elseif ($result.VulnerableChannelAllowList) {
                            $vulnerabilityStatus = 'Potentially vulnerable (allow list bypasses protection)'
                        } else {
                            $vulnerabilityStatus = 'Potentially vulnerable (verify patches)'
                        }
                    }

                } catch {
                    $vulnerabilityStatus = 'Unable to verify - manual check required'
                    $enforcementMode = 'Unable to check'
                }

                # Report if potentially vulnerable or unable to verify
                if ($vulnerabilityStatus -match 'vulnerable|Unable') {
                    $findings += [PSCustomObject]@{
                        DomainController    = $dcName
                        VulnerabilityStatus = $vulnerabilityStatus
                        EnforcementMode     = $enforcementMode
                        PatchStatus         = $patchStatus
                        CVE                 = 'CVE-2020-1472'
                        CVSS                = '10.0 (Critical)'
                        ExploitAvailable    = 'Yes - Public exploits available'
                        AttackVector        = 'Unauthenticated attacker can set DC password to empty and take over domain'
                        RiskLevel           = 'Critical'
                        OperatingSystem     = $dc.OperatingSystem
                        DistinguishedName   = $dc.DistinguishedName
                    }
                }
            }
        }

        return $findings
    }

    Remediation = @{
        Description = 'Apply August 2020 or later security updates and enable full Netlogon secure channel enforcement.'
        Impact      = 'Medium - Enforcement mode may break legacy devices. Test with monitoring mode first.'
        Script      = {
            param($Finding, $Domain)

            $commands = @"
#############################################################################
# Zerologon (CVE-2020-1472) Remediation
#############################################################################
#
# Zerologon is one of the most critical AD vulnerabilities:
# - CVSS Score: 10.0 (Maximum)
# - Attack: Unauthenticated, from network
# - Impact: Complete domain takeover
# - Time to exploit: Seconds
#
# Attack process:
# 1. Attacker sends specially crafted Netlogon messages
# 2. DC password is set to empty
# 3. Attacker authenticates as DC
# 4. Attacker uses DCSync to extract all hashes
# 5. Domain is completely compromised
#
# Potentially Vulnerable DCs:
$($Finding.Findings | ForEach-Object { "# - $($_.DomainController): $($_.VulnerabilityStatus)" } | Out-String)

#############################################################################
# Step 1: Install Security Patches IMMEDIATELY
#############################################################################

# Install August 2020 or later cumulative updates on ALL Domain Controllers
# This is the PRIMARY fix for Zerologon

# Check current patch status:
Get-ADDomainController -Filter * | ForEach-Object {
    `$patches = Invoke-Command -ComputerName `$_.HostName -ScriptBlock {
        Get-HotFix | Where-Object { `$_.InstalledOn -ge '2020-08-01' } |
            Sort-Object InstalledOn -Descending | Select-Object -First 3
    }
    Write-Host "`n`$(`$_.HostName):" -ForegroundColor Cyan
    `$patches | Format-Table HotFixID, InstalledOn
}

# Install updates via Windows Update, WSUS, or SCCM
# Reboot is required after installation

#############################################################################
# Step 2: Enable Full Enforcement Mode
#############################################################################

# After patching, enable full secure channel enforcement
# This is REQUIRED for complete protection

`$dcs = Get-ADDomainController -Filter *

foreach (`$dc in `$dcs) {
    Invoke-Command -ComputerName `$dc.HostName -ScriptBlock {
        `$regPath = 'HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters'

        # Enable full enforcement
        Set-ItemProperty -Path `$regPath -Name 'FullSecureChannelProtection' -Value 1 -Type DWord

        Write-Host "Full Netlogon enforcement enabled on `$env:COMPUTERNAME" -ForegroundColor Green
    }
}

# Enforcement is automatic since February 2022 (after DC-only phase)
# But verify it's enabled

#############################################################################
# Step 3: Remove Allow List (If Present)
#############################################################################

# VulnerableChannelAllowList bypasses protection for listed devices
# Remove this if possible, or document required exceptions

foreach (`$dc in `$dcs) {
    Invoke-Command -ComputerName `$dc.HostName -ScriptBlock {
        `$regPath = 'HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters'

        # Check for allow list
        `$allowList = Get-ItemProperty -Path `$regPath -Name 'VulnerableChannelAllowList' -ErrorAction SilentlyContinue

        if (`$allowList.VulnerableChannelAllowList) {
            Write-Host "WARNING: VulnerableChannelAllowList exists: `$(`$allowList.VulnerableChannelAllowList)" -ForegroundColor Yellow
            # Remove if not needed:
            # Remove-ItemProperty -Path `$regPath -Name 'VulnerableChannelAllowList'
        } else {
            Write-Host "No VulnerableChannelAllowList configured" -ForegroundColor Green
        }
    }
}

#############################################################################
# Step 4: Monitor for Zerologon Attempts
#############################################################################

# Event ID 5829 - Vulnerable Netlogon secure channel connection allowed
# Event ID 5827 - Netlogon service denied a vulnerable connection
# Event ID 5828 - Netlogon service denied a DC using vulnerable connection

# Check for exploitation attempts:
Get-ADDomainController -Filter * | ForEach-Object {
    `$events = Invoke-Command -ComputerName `$_.HostName -ScriptBlock {
        Get-WinEvent -FilterHashtable @{LogName='System'; Id=5827,5828,5829} -MaxEvents 100 -ErrorAction SilentlyContinue
    }
    if (`$events) {
        Write-Host "`n`$(`$_.HostName) - Zerologon-related events:" -ForegroundColor Yellow
        `$events | Select-Object TimeCreated, Id, Message | Format-Table
    }
}

#############################################################################
# Step 5: Verify Protection
#############################################################################

# Check enforcement status on all DCs:
Get-ADDomainController -Filter * | ForEach-Object {
    `$status = Invoke-Command -ComputerName `$_.HostName -ScriptBlock {
        `$path = 'HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters'
        @{
            FullSecure = (Get-ItemProperty -Path `$path -Name 'FullSecureChannelProtection' -ErrorAction SilentlyContinue).FullSecureChannelProtection
            AllowList = (Get-ItemProperty -Path `$path -Name 'VulnerableChannelAllowList' -ErrorAction SilentlyContinue).VulnerableChannelAllowList
        }
    }

    `$protection = if (`$status.FullSecure -eq 1) { 'PROTECTED' } else { 'NOT ENFORCED' }
    `$color = if (`$status.FullSecure -eq 1) { 'Green' } else { 'Red' }
    Write-Host "`$(`$_.HostName): `$protection" -ForegroundColor `$color
    if (`$status.AllowList) {
        Write-Host "  Allow list: `$(`$status.AllowList)" -ForegroundColor Yellow
    }
}

#############################################################################
# If Compromise Suspected
#############################################################################

# If you believe Zerologon was exploited:
# 1. Isolate affected DCs
# 2. Reset DC computer account passwords
# 3. Reset krbtgt password TWICE
# 4. Reset all privileged account passwords
# 5. Rebuild DCs from known-good media
# 6. Full incident response engagement

"@
            return $commands
        }
    }
}

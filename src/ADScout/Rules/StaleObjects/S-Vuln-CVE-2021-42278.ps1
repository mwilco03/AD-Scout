<#
.SYNOPSIS
    Detects vulnerability to CVE-2021-42278/42287 (noPac/sAMAccountName spoofing).

.DESCRIPTION
    The noPac attack exploits CVE-2021-42278 (sAMAccountName spoofing) combined with
    CVE-2021-42287 (KDC PAC confusion) to escalate from any domain user to Domain Admin.
    This rule checks for missing patches and exploitable conditions.

.NOTES
    Rule ID    : S-Vuln-CVE-2021-42278
    Category   : StaleObjects
    Author     : AD-Scout Contributors
    Version    : 1.0.0
#>

@{
    Id          = 'S-Vuln-CVE-2021-42278'
    Version     = '1.0.0'
    Category    = 'StaleObjects'
    Title       = 'noPac Vulnerability (CVE-2021-42278/42287)'
    Description = 'Detects if the domain is vulnerable to the noPac attack which allows any authenticated user to escalate to Domain Admin by exploiting sAMAccountName spoofing and PAC confusion.'
    Severity    = 'Critical'
    Weight      = 90
    DataSource  = 'DomainControllers'

    References  = @(
        @{ Title = 'CVE-2021-42278'; Url = 'https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-42278' }
        @{ Title = 'CVE-2021-42287'; Url = 'https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-42287' }
        @{ Title = 'noPac Exploit'; Url = 'https://github.com/Ridter/noPac' }
        @{ Title = 'Microsoft KB5008380'; Url = 'https://support.microsoft.com/en-us/topic/kb5008380-authentication-updates-cve-2021-42287-9dafac11-e0d0-4cb8-959a-143bd0201041' }
    )

    MITRE = @{
        Tactics    = @('TA0004', 'TA0003')  # Privilege Escalation, Persistence
        Techniques = @('T1078.002', 'T1558.001')  # Domain Accounts, Golden Ticket
    }

    CIS   = @('18.3.6')
    STIG  = @('V-254442')
    ANSSI = @('vuln1_nopac')

    Scoring = @{
        Type    = 'TriggerOnPresence'
    }

    Detect = {
        param($Data, $Domain)

        $findings = @()

        if ($Data.DomainControllers) {
            foreach ($dc in $Data.DomainControllers) {
                $dcName = $dc.Name
                if (-not $dcName) { $dcName = $dc.DnsHostName }
                if (-not $dcName) { continue }

                try {
                    $patchStatus = Invoke-Command -ComputerName $dcName -ScriptBlock {
                        $result = @{
                            ComputerName = $env:COMPUTERNAME
                            OSVersion = (Get-WmiObject Win32_OperatingSystem).Version
                            PatchInstalled = $false
                            PACValidation = $null
                            RequiredKBs = @()
                            InstalledKBs = @()
                        }

                        # Check for November 2021 or later security updates
                        # KB5008602 (Server 2022), KB5008601 (Server 2019), KB5008594 (Server 2016)
                        $requiredKBs = @('KB5008602', 'KB5008601', 'KB5008594', 'KB5008380', 'KB5008206', 'KB5007206')
                        $result.RequiredKBs = $requiredKBs

                        $installedPatches = Get-HotFix | Where-Object {
                            $_.InstalledOn -ge [DateTime]'2021-11-01'
                        }
                        $result.InstalledKBs = $installedPatches.HotFixID

                        foreach ($kb in $requiredKBs) {
                            if ($installedPatches.HotFixID -contains $kb) {
                                $result.PatchInstalled = $true
                                break
                            }
                        }

                        # Also check if any cumulative update from Nov 2021 or later
                        $latestCU = Get-HotFix | Where-Object {
                            $_.Description -match 'Security Update|Cumulative' -and
                            $_.InstalledOn -ge [DateTime]'2021-11-09'
                        } | Sort-Object InstalledOn -Descending | Select-Object -First 1

                        if ($latestCU) {
                            $result.PatchInstalled = $true
                        }

                        # Check PAC validation registry setting (KB5008380 enforcement)
                        # PacRequestorEnforcement: 0=Disabled, 1=Compatibility, 2=Enforcement
                        $pacKey = Get-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\Kdc' -Name 'PacRequestorEnforcement' -ErrorAction SilentlyContinue
                        $result.PACValidation = $pacKey.PacRequestorEnforcement

                        return $result
                    } -ErrorAction SilentlyContinue

                    $issues = @()
                    $isVulnerable = $false

                    if (-not $patchStatus.PatchInstalled) {
                        $issues += 'November 2021 security update NOT installed'
                        $isVulnerable = $true
                    }

                    # Check PAC validation enforcement
                    if ($null -eq $patchStatus.PACValidation -or $patchStatus.PACValidation -eq 0) {
                        $issues += 'PacRequestorEnforcement not configured (vulnerable)'
                        $isVulnerable = $true
                    } elseif ($patchStatus.PACValidation -eq 1) {
                        $issues += 'PacRequestorEnforcement = 1 (compatibility mode - partially vulnerable)'
                        $isVulnerable = $true
                    }
                    # Value 2 = Full enforcement (secure)

                    if ($isVulnerable) {
                        $findings += [PSCustomObject]@{
                            DomainController      = $dcName
                            OSVersion             = $patchStatus.OSVersion
                            PatchInstalled        = $patchStatus.PatchInstalled
                            PACEnforcement        = if ($null -eq $patchStatus.PACValidation) { 'Not set (0)' } else { $patchStatus.PACValidation }
                            Issues                = ($issues -join '; ')
                            CVEs                  = 'CVE-2021-42278, CVE-2021-42287'
                            RiskLevel             = 'Critical'
                            AttackPath            = 'Any user -> Create machine acct -> Rename to DC$ -> Get TGT -> Rename back -> S4U2Self -> DCSync'
                            ExploitAvailable      = 'Yes (noPac, Rubeus)'
                            DistinguishedName     = $dc.DistinguishedName
                        }
                    }

                } catch {
                    $findings += [PSCustomObject]@{
                        DomainController      = $dcName
                        OSVersion             = 'Unknown'
                        PatchInstalled        = 'Unknown (check failed)'
                        PACEnforcement        = 'Unknown'
                        Issues                = 'Unable to verify patch status - manual check required'
                        CVEs                  = 'CVE-2021-42278, CVE-2021-42287'
                        RiskLevel             = 'Critical'
                        AttackPath            = 'Assume vulnerable until verified'
                        ExploitAvailable      = 'Yes'
                        DistinguishedName     = $dc.DistinguishedName
                    }
                }
            }
        }

        # Also check if MachineAccountQuota > 0 (required for standard attack path)
        if ($findings.Count -gt 0) {
            try {
                $maq = (Get-ADObject -Identity (Get-ADDomain).DistinguishedName -Properties 'ms-DS-MachineAccountQuota').'ms-DS-MachineAccountQuota'
                foreach ($f in $findings) {
                    $f | Add-Member -NotePropertyName 'MachineAccountQuota' -NotePropertyValue $maq -Force
                    if ($maq -gt 0) {
                        $f | Add-Member -NotePropertyName 'MAQNote' -NotePropertyValue "MAQ=$maq allows unauthenticated machine account creation" -Force
                    }
                }
            } catch {}
        }

        return $findings
    }

    Remediation = @{
        Description = 'Install November 2021 security updates and enable PAC validation enforcement.'
        Impact      = 'Low - Security update with no expected compatibility issues after testing.'
        Script      = {
            param($Finding, $Domain)

            $commands = @"
#############################################################################
# CVE-2021-42278/42287 (noPac) Remediation
#############################################################################
#
# The noPac attack allows ANY domain user to become Domain Admin:
# 1. Create a machine account (if MAQ > 0)
# 2. Rename machine account sAMAccountName to match a DC (e.g., "DC01")
# 3. Request a TGT for the spoofed name
# 4. Rename machine account back to original
# 5. Use TGT with S4U2Self to impersonate Domain Admin
# 6. DCSync to extract all credentials
#
# This attack is trivial to execute with public tools (noPac, Rubeus).
#
# Vulnerable DCs:
$($Finding.Findings | ForEach-Object { "# - $($_.DomainController): $($_.Issues)" } | Out-String)

#############################################################################
# Step 1: Install Security Updates (CRITICAL)
#############################################################################

# Install November 2021 or later cumulative updates on ALL Domain Controllers:
#
# Windows Server 2022: KB5007205 or later
# Windows Server 2019: KB5007206 or later
# Windows Server 2016: KB5007192 or later
# Windows Server 2012 R2: KB5007247 or later
#
# Use Windows Update, WSUS, or SCCM to deploy updates

# Verify update installation:
`$dcs = Get-ADDomainController -Filter *
foreach (`$dc in `$dcs) {
    `$patches = Invoke-Command -ComputerName `$dc.HostName -ScriptBlock {
        Get-HotFix | Where-Object { `$_.InstalledOn -ge '2021-11-09' } |
            Sort-Object InstalledOn -Descending | Select-Object -First 5
    }
    Write-Host "`$(`$dc.HostName):" -ForegroundColor Cyan
    `$patches | Format-Table HotFixID, InstalledOn, Description
}

#############################################################################
# Step 2: Enable PAC Validation Enforcement
#############################################################################

# After installing updates, configure PAC requestor enforcement:
# 0 = Disabled (VULNERABLE)
# 1 = Compatibility mode (logs but allows - VULNERABLE)
# 2 = Enforcement mode (SECURE)

# Enable enforcement on all DCs:
foreach (`$dc in `$dcs) {
    Invoke-Command -ComputerName `$dc.HostName -ScriptBlock {
        Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\Kdc' `
            -Name 'PacRequestorEnforcement' -Value 2 -Type DWord

        Write-Host "Enabled PAC Enforcement on `$env:COMPUTERNAME" -ForegroundColor Green
    }
}

# Note: Microsoft enforced this by default starting July 2022
# If you're still vulnerable, you're missing critical updates

#############################################################################
# Step 3: Reduce Machine Account Quota
#############################################################################

# Standard attack requires creating a machine account
# Set MAQ to 0 to prevent unprivileged users from creating machine accounts:

Set-ADDomain -Identity (Get-ADDomain) -Replace @{'ms-DS-MachineAccountQuota'=0}

# Verify:
(Get-ADDomain).'ms-DS-MachineAccountQuota'

# Note: Legitimate machine account creation should be delegated to specific
# groups or handled via SCCM/MDT provisioning

#############################################################################
# Step 4: Enable Monitoring
#############################################################################

# Monitor for noPac attack indicators:
# - Event ID 4741: Computer account created
# - Event ID 4742: Computer account changed (sAMAccountName modification)
# - Event ID 4768: TGT requested for computer account
# - Rapid create/rename/request/rename pattern

# PowerShell detection query:
Get-WinEvent -FilterHashtable @{
    LogName = 'Security'
    ID = 4742
    StartTime = (Get-Date).AddHours(-24)
} | Where-Object {
    `$_.Message -match 'SAM Account Name'
} | Format-Table TimeCreated, Message -Wrap

#############################################################################
# Step 5: Verify Remediation
#############################################################################

# Check all DCs are patched and enforcing:
foreach (`$dc in `$dcs) {
    `$status = Invoke-Command -ComputerName `$dc.HostName -ScriptBlock {
        `$pac = (Get-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\Kdc' -Name 'PacRequestorEnforcement' -EA SilentlyContinue).PacRequestorEnforcement
        `$patched = (Get-HotFix | Where-Object { `$_.InstalledOn -ge '2021-11-09' }).Count -gt 0
        @{
            ComputerName = `$env:COMPUTERNAME
            Patched = `$patched
            PACEnforcement = `$pac
            Secure = (`$patched -and `$pac -eq 2)
        }
    }

    `$color = if (`$status.Secure) { 'Green' } else { 'Red' }
    Write-Host "`$(`$status.ComputerName): Patched=`$(`$status.Patched), PAC=`$(`$status.PACEnforcement), Secure=`$(`$status.Secure)" -ForegroundColor `$color
}

"@
            return $commands
        }
    }
}

<#
.SYNOPSIS
    Detects MS17-010 (EternalBlue) vulnerability.

.DESCRIPTION
    Uses SMBLibrary for safe detection of EternalBlue vulnerability.
    This affects systems with SMBv1 enabled and without MS17-010 patches.

.NOTES
    Rule ID    : DLL-VULN-EternalBlue
    Category   : DLLRequired
    Requires   : SMBLibrary.dll
    Author     : AD-Scout Contributors
    Safety     : This rule performs SAFE detection only
#>

@{
    Id          = 'DLL-VULN-EternalBlue'
    Version     = '1.0.0'
    Category    = 'AttackVectors'
    Title       = 'EternalBlue Vulnerability (MS17-010)'
    Description = 'Systems with SMBv1 enabled may be vulnerable to MS17-010 (EternalBlue), a critical vulnerability used by WannaCry and NotPetya ransomware.'
    Severity    = 'Critical'
    Weight      = 75
    DataSource  = 'DomainControllers'

    RequiresDLL     = $true
    DLLNames        = @('SMBLibrary.dll')
    FallbackBehavior = 'Skip'

    References  = @(
        @{ Title = 'MS17-010'; Url = 'https://docs.microsoft.com/en-us/security-updates/securitybulletins/2017/ms17-010' }
        @{ Title = 'EternalBlue Analysis'; Url = 'https://www.sentinelone.com/blog/eternalblue-nsa-developed-exploit-just-wont-die/' }
        @{ Title = 'Disable SMBv1'; Url = 'https://docs.microsoft.com/en-us/windows-server/storage/file-server/troubleshoot/detect-enable-and-disable-smbv1-v2-v3' }
    )

    MITRE = @{
        Tactics    = @('TA0002', 'TA0008')  # Execution, Lateral Movement
        Techniques = @('T1210')             # Exploitation of Remote Services
    }

    CVE   = @('CVE-2017-0143', 'CVE-2017-0144', 'CVE-2017-0145', 'CVE-2017-0146', 'CVE-2017-0147', 'CVE-2017-0148')
    STIG  = @('V-78057')
    NIST  = @('SI-2', 'CM-6')

    Scoring = @{
        Type    = 'PerDiscovery'
        PerItem = 40
        Maximum = 160
    }

    Detect = {
        param($Data, $Domain)

        if (-not (Initialize-ADScoutSMBLibrary)) {
            Write-Warning "DLL-VULN-EternalBlue: SMBLibrary not available, skipping"
            return @()
        }

        $findings = @()

        foreach ($dc in $Data) {
            $dcName = $dc.Name
            if (-not $dcName) { $dcName = $dc.DnsHostName }
            if (-not $dcName) { continue }

            try {
                $scanResult = Invoke-EternalBlueScan -ComputerName $dcName -TimeoutMs 5000

                if ($scanResult.Status -eq 'Success' -and $scanResult.Vulnerable) {
                    $findings += [PSCustomObject]@{
                        DomainController        = $dcName
                        OperatingSystem         = $dc.OperatingSystem
                        SMB1Enabled             = $scanResult.SMB1Enabled
                        SMB1Negotiated          = $scanResult.SMB1Negotiated
                        EternalBlueVulnerable   = $scanResult.EternalBlueVulnerable
                        CVE                     = 'CVE-2017-0144 (and related)'
                        MS                      = 'MS17-010'
                        CVSS                    = '8.1 (High)'
                        RiskLevel               = 'Critical'
                        AttackVector            = 'Remote code execution, WannaCry/NotPetya ransomware'
                        ImmediateAction         = 'PATCH IMMEDIATELY and disable SMBv1'
                        DistinguishedName       = $dc.DistinguishedName
                    }
                }
            } catch {
                Write-Verbose "DLL-VULN-EternalBlue: Error scanning $dcName - $($_.Exception.Message)"
            }
        }

        return $findings
    }

    Remediation = @{
        Description = 'Apply MS17-010 security update and disable SMBv1.'
        Impact      = 'Low - SMBv1 is deprecated and should be disabled.'
        Script      = {
            param($Finding, $Domain)

            @"
##############################################################################
# CRITICAL: EternalBlue (MS17-010) Remediation
##############################################################################
#
# EternalBlue was the exploit used in:
# - WannaCry ransomware (May 2017)
# - NotPetya wiper (June 2017)
# - Numerous other attacks
#
# This is a KNOWN, WEAPONIZED vulnerability!
#
##############################################################################

# Step 1: Check for MS17-010 patch
`$patchKBs = @('KB4012598', 'KB4012212', 'KB4012213', 'KB4012214', 'KB4012215', 'KB4012216', 'KB4012217')
Get-HotFix | Where-Object { `$patchKBs -contains `$_.HotFixID }

# Step 2: Install MS17-010 patch if missing
# Download from Microsoft Update Catalog:
# https://www.catalog.update.microsoft.com/Search.aspx?q=MS17-010

# Step 3: DISABLE SMBv1 (CRITICAL)
# SMBv1 should be disabled regardless of patch status

# PowerShell (Windows 8.1/Server 2012 R2+):
Disable-WindowsOptionalFeature -Online -FeatureName SMB1Protocol -NoRestart
Set-SmbServerConfiguration -EnableSMB1Protocol `$false -Force

# Registry (older systems):
Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters' `
    -Name 'SMB1' -Value 0 -Type DWord

# Verify SMBv1 is disabled:
Get-SmbServerConfiguration | Select-Object EnableSMB1Protocol
Get-WindowsOptionalFeature -Online -FeatureName SMB1Protocol

# Step 4: Verify protection
# Use Invoke-SMBDialectScan to confirm SMB1 is no longer responding

# REBOOT REQUIRED after changes

Write-Warning "REBOOT REQUIRED to complete SMBv1 removal"
"@
        }
    }
}

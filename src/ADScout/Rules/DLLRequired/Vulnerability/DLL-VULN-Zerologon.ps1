<#
.SYNOPSIS
    Detects CVE-2020-1472 (Zerologon) vulnerability on Domain Controllers.

.DESCRIPTION
    Uses SMBLibrary and RPCForSMBLibrary for SAFE detection of Zerologon.
    This scanner does NOT exploit the vulnerability - it only tests if
    the DC properly rejects null authentication attempts.

.NOTES
    Rule ID    : DLL-VULN-Zerologon
    Category   : DLLRequired
    Requires   : SMBLibrary.dll, RPCForSMBLibrary.dll
    Author     : AD-Scout Contributors
    Safety     : This rule performs SAFE detection only
#>

@{
    Id          = 'DLL-VULN-Zerologon'
    Version     = '1.0.0'
    Category    = 'AttackVectors'
    Title       = 'Zerologon Vulnerability (CVE-2020-1472)'
    Description = 'Domain Controllers may be vulnerable to CVE-2020-1472 (Zerologon), a critical vulnerability that allows complete domain compromise without credentials.'
    Severity    = 'Critical'
    Weight      = 100
    DataSource  = 'DomainControllers'

    RequiresDLL     = $true
    DLLNames        = @('SMBLibrary.dll', 'RPCForSMBLibrary.dll')
    FallbackBehavior = 'Skip'

    References  = @(
        @{ Title = 'CVE-2020-1472'; Url = 'https://msrc.microsoft.com/update-guide/vulnerability/CVE-2020-1472' }
        @{ Title = 'Zerologon Explained'; Url = 'https://www.secura.com/blog/zero-logon' }
        @{ Title = 'Microsoft Security Update'; Url = 'https://support.microsoft.com/kb4565349' }
    )

    MITRE = @{
        Tactics    = @('TA0004', 'TA0006')  # Privilege Escalation, Credential Access
        Techniques = @('T1068', 'T1003')    # Exploitation, Credential Dumping
    }

    STIG  = @('V-95627')
    NIST  = @('SI-2', 'CM-6')

    Scoring = @{
        Type    = 'PerDiscovery'
        PerItem = 50
        Maximum = 200
    }

    Detect = {
        param($Data, $Domain)

        if (-not (Initialize-ADScoutSMBLibrary)) {
            Write-Warning "DLL-VULN-Zerologon: SMBLibrary not available, skipping"
            return @()
        }

        $findings = @()

        foreach ($dc in $Data) {
            $dcName = $dc.Name
            if (-not $dcName) { $dcName = $dc.DnsHostName }
            if (-not $dcName) { continue }

            try {
                $scanResult = Invoke-ZerologonScan -ComputerName $dcName -TimeoutMs 10000

                if ($scanResult.Status -eq 'Success') {
                    if ($scanResult.ZerologonVulnerable) {
                        # CRITICAL: Actually vulnerable
                        $findings += [PSCustomObject]@{
                            DomainController      = $dcName
                            OperatingSystem       = $dc.OperatingSystem
                            ZerologonVulnerable   = $true
                            ZerologonPatched      = $false
                            NetlogonAccessible    = $scanResult.NetlogonAccessible
                            NullCredentialRejected = $false
                            CVE                   = 'CVE-2020-1472'
                            CVSS                  = '10.0 (Critical)'
                            RiskLevel             = 'Critical'
                            AttackVector          = 'Zerologon -> Reset DC password -> DCSync -> Full domain compromise'
                            ImmediateAction       = 'PATCH IMMEDIATELY - DC can be compromised without authentication'
                            DistinguishedName     = $dc.DistinguishedName
                        }
                    } elseif ($scanResult.ZerologonPatched -eq $null -and $scanResult.NetlogonAccessible) {
                        # Uncertain - needs verification
                        $findings += [PSCustomObject]@{
                            DomainController      = $dcName
                            OperatingSystem       = $dc.OperatingSystem
                            ZerologonVulnerable   = $null
                            ZerologonPatched      = $null
                            NetlogonAccessible    = $true
                            NullCredentialRejected = $null
                            CVE                   = 'CVE-2020-1472'
                            RiskLevel             = 'High'
                            AttackVector          = 'Verify patch status for CVE-2020-1472'
                            ImmediateAction       = 'Verify patch KB4565349 or later is installed'
                            DistinguishedName     = $dc.DistinguishedName
                        }
                    }
                }
            } catch {
                Write-Verbose "DLL-VULN-Zerologon: Error scanning $dcName - $($_.Exception.Message)"
            }
        }

        return $findings
    }

    Remediation = @{
        Description = 'IMMEDIATELY apply security updates to patch CVE-2020-1472.'
        Impact      = 'None - Patching is essential and has no negative impact.'
        Script      = {
            param($Finding, $Domain)

            @"
##############################################################################
# CRITICAL: Zerologon (CVE-2020-1472) Remediation
##############################################################################
#
# Zerologon allows an attacker to completely compromise your domain
# WITHOUT ANY CREDENTIALS. This is a MAXIMUM SEVERITY vulnerability.
#
# Attack Impact:
# 1. Attacker resets DC machine account password to null
# 2. Attacker authenticates as the DC
# 3. Attacker performs DCSync to dump all credentials
# 4. Complete domain compromise in seconds
#
##############################################################################

# STEP 1: VERIFY PATCH STATUS (IMMEDIATE)
# Check if the security update is installed

foreach (`$dc in @($($Finding.Findings.DomainController | ForEach-Object { "'$_'" } -join ', '))) {
    Write-Host "Checking `$dc..."
    Get-HotFix -ComputerName `$dc | Where-Object {
        `$_.HotFixID -match 'KB4565349|KB4566782|KB4571694|KB4577051|KB4580325|KB5005568'
    } | Select-Object HotFixID, InstalledOn

    # Also check DC functionality level
    (Get-ADDomainController -Identity `$dc).OperatingSystemVersion
}

# STEP 2: INSTALL PATCHES (IMMEDIATE IF NOT PATCHED)
# Download and install the appropriate KB for your Windows version:
# - Windows Server 2008 R2: KB4565349 or later
# - Windows Server 2012: KB4565349 or later
# - Windows Server 2012 R2: KB4565349 or later
# - Windows Server 2016: KB4565349 or later
# - Windows Server 2019: KB4565349 or later
# - Windows Server 2022: Already patched if current

# Use Windows Update or WSUS:
# wusa.exe WindowsUpdate.msu /quiet /norestart

# STEP 3: ENABLE ENFORCEMENT MODE
# After patching, enable enforcement to block vulnerable connections
# This is critical for complete protection

# Check current enforcement status:
Get-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters' `
    -Name 'FullSecureChannelProtection' -ErrorAction SilentlyContinue

# Enable enforcement:
Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters' `
    -Name 'FullSecureChannelProtection' -Value 1 -Type DWord

# STEP 4: MONITOR FOR VULNERABLE CONNECTIONS
# Enable Netlogon auditing to identify vulnerable clients
# Event ID 5829 indicates vulnerable connection attempts

Get-WinEvent -FilterHashtable @{
    LogName = 'System'
    ID = 5827, 5828, 5829, 5830, 5831
} -MaxEvents 50 -ErrorAction SilentlyContinue |
    Select-Object TimeCreated, ID, Message

# STEP 5: VERIFY PROTECTION
# After patching and enabling enforcement, verify protection:
# - Run this detection rule again - should return no findings
# - Check that Netlogon service is running
# - Verify no Event 5829 in logs

# IMPORTANT: Do not delay patching. Every moment unpatched is a risk.
"@
        }
    }
}

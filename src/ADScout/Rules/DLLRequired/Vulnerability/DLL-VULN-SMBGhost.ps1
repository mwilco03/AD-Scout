<#
.SYNOPSIS
    Detects CVE-2020-0796 (SMBGhost) vulnerability.

.DESCRIPTION
    Uses SMBLibrary for safe detection of SMBGhost vulnerability.
    This affects Windows 10 v1903+ and Windows Server v1903+ with
    SMB 3.1.1 compression enabled.

.NOTES
    Rule ID    : DLL-VULN-SMBGhost
    Category   : DLLRequired
    Requires   : SMBLibrary.dll
    Author     : AD-Scout Contributors
    Safety     : This rule performs SAFE detection only
#>

@{
    Id          = 'DLL-VULN-SMBGhost'
    Version     = '1.0.0'
    Category    = 'AttackVectors'
    Title       = 'SMBGhost Vulnerability (CVE-2020-0796)'
    Description = 'Systems may be vulnerable to CVE-2020-0796 (SMBGhost/CoronaBlue), a critical SMB compression vulnerability allowing remote code execution.'
    Severity    = 'Critical'
    Weight      = 50
    DataSource  = 'DomainControllers'

    RequiresDLL     = $true
    DLLNames        = @('SMBLibrary.dll')
    FallbackBehavior = 'Skip'

    References  = @(
        @{ Title = 'CVE-2020-0796'; Url = 'https://msrc.microsoft.com/update-guide/vulnerability/CVE-2020-0796' }
        @{ Title = 'SMBGhost Analysis'; Url = 'https://blog.zecops.com/vulnerabilities/exploiting-smbghost-cve-2020-0796-for-a-local-privilege-escalation-writeup-and-poc/' }
        @{ Title = 'Microsoft Security Update'; Url = 'https://support.microsoft.com/kb4551762' }
    )

    MITRE = @{
        Tactics    = @('TA0002', 'TA0004')  # Execution, Privilege Escalation
        Techniques = @('T1210', 'T1068')
    }

    NIST  = @('SI-2', 'CM-6')

    Scoring = @{
        Type    = 'PerDiscovery'
        PerItem = 25
        Maximum = 100
    }

    Detect = {
        param($Data, $Domain)

        if (-not (Initialize-ADScoutSMBLibrary)) {
            Write-Warning "DLL-VULN-SMBGhost: SMBLibrary not available, skipping"
            return @()
        }

        $findings = @()

        foreach ($dc in $Data) {
            $dcName = $dc.Name
            if (-not $dcName) { $dcName = $dc.DnsHostName }
            if (-not $dcName) { continue }

            try {
                $scanResult = Invoke-SMBGhostScan -ComputerName $dcName -TimeoutMs 5000

                if ($scanResult.Status -eq 'Success' -and $scanResult.Vulnerable) {
                    $findings += [PSCustomObject]@{
                        DomainController      = $dcName
                        OperatingSystem       = $dc.OperatingSystem
                        SMB311Supported       = $scanResult.SMB311Supported
                        CompressionSupported  = $scanResult.CompressionSupported
                        SMBGhostVulnerable    = $scanResult.SMBGhostVulnerable
                        CVE                   = 'CVE-2020-0796'
                        CVSS                  = '10.0 (Critical)'
                        RiskLevel             = 'Critical'
                        AttackVector          = 'Remote code execution via malformed SMB compression'
                        RequiredPatch         = 'KB4551762'
                        DistinguishedName     = $dc.DistinguishedName
                    }
                }
            } catch {
                Write-Verbose "DLL-VULN-SMBGhost: Error scanning $dcName - $($_.Exception.Message)"
            }
        }

        return $findings
    }

    Remediation = @{
        Description = 'Apply security update KB4551762 or disable SMB compression.'
        Impact      = 'None - Patching is essential.'
        Script      = {
            param($Finding, $Domain)

            @"
# SMBGhost (CVE-2020-0796) Remediation

# CVE-2020-0796 affects:
# - Windows 10 Version 1903 and 1909
# - Windows Server Version 1903 and 1909

# OPTION 1: APPLY PATCH (Recommended)
# Install KB4551762 or later cumulative update
# Check patch status:
Get-HotFix | Where-Object { `$_.HotFixID -eq 'KB4551762' }

# OPTION 2: DISABLE SMB COMPRESSION (Workaround)
# If patching is not immediately possible:
Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters' `
    -Name 'DisableCompression' -Value 1 -Type DWord

# Verify compression is disabled:
Get-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters' |
    Select-Object DisableCompression

# Note: No reboot required for workaround, but patch is preferred

# VERIFY PROTECTION:
# After patching, this detection should return no findings
"@
        }
    }
}

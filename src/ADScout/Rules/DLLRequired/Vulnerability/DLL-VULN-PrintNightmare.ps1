<#
.SYNOPSIS
    Detects PrintNightmare (CVE-2021-1675/CVE-2021-34527) vulnerability conditions.

.DESCRIPTION
    Uses SMBLibrary to detect if Print Spooler conditions that enable
    PrintNightmare exploitation are present. PrintNightmare is a critical
    remote code execution vulnerability in Windows Print Spooler.

.NOTES
    Rule ID    : DLL-VULN-PrintNightmare
    Category   : DLLRequired
    Requires   : SMBLibrary.dll
    Author     : AD-Scout Contributors
    Safety     : This rule performs SAFE detection only
#>

@{
    Id          = 'DLL-VULN-PrintNightmare'
    Version     = '1.0.0'
    Category    = 'AttackVectors'
    Title       = 'PrintNightmare Vulnerability Conditions (CVE-2021-34527)'
    Description = 'Print Spooler conditions that enable PrintNightmare exploitation are present, allowing remote code execution on Domain Controllers.'
    Severity    = 'Critical'
    Weight      = 60
    DataSource  = 'DomainControllers'

    RequiresDLL     = $true
    DLLNames        = @('SMBLibrary.dll')
    FallbackBehavior = 'Skip'

    References  = @(
        @{ Title = 'CVE-2021-34527'; Url = 'https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527' }
        @{ Title = 'PrintNightmare Guidance'; Url = 'https://msrc-blog.microsoft.com/2021/07/08/clarified-guidance-for-cve-2021-34527-windows-print-spooler-vulnerability/' }
        @{ Title = 'KB5005010'; Url = 'https://support.microsoft.com/kb5005010' }
    )

    MITRE = @{
        Tactics    = @('TA0002', 'TA0004')  # Execution, Privilege Escalation
        Techniques = @('T1210', 'T1068')
    }

    CVE   = @('CVE-2021-1675', 'CVE-2021-34527')
    STIG  = @('V-73401')
    NIST  = @('SI-2', 'CM-6')

    Scoring = @{
        Type    = 'PerDiscovery'
        PerItem = 30
        Maximum = 120
    }

    Detect = {
        param($Data, $Domain)

        if (-not (Initialize-ADScoutSMBLibrary)) {
            Write-Warning "DLL-VULN-PrintNightmare: SMBLibrary not available, skipping"
            return @()
        }

        $findings = @()

        foreach ($dc in $Data) {
            $dcName = $dc.Name
            if (-not $dcName) { $dcName = $dc.DnsHostName }
            if (-not $dcName) { continue }

            try {
                # Check if Spooler is accessible
                $spoolerResult = Invoke-SpoolerScan -ComputerName $dcName -TimeoutMs 5000

                if ($spoolerResult.Status -eq 'Success' -and $spoolerResult.SpoolerAccessible) {
                    # Check for Point and Print restrictions and patches
                    $vulnerable = $true
                    $patchVerified = $false
                    $pointPrintRestricted = $false

                    # Try to check registry for Point and Print restrictions
                    try {
                        if ($dcName -eq $env:COMPUTERNAME) {
                            $noWarning = Get-ItemProperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint' -Name 'NoWarningNoElevationOnInstall' -ErrorAction SilentlyContinue |
                                Select-Object -ExpandProperty NoWarningNoElevationOnInstall
                            $restrictDriverInstall = Get-ItemProperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint' -Name 'RestrictDriverInstallationToAdministrators' -ErrorAction SilentlyContinue |
                                Select-Object -ExpandProperty RestrictDriverInstallationToAdministrators

                            if ($restrictDriverInstall -eq 1) {
                                $pointPrintRestricted = $true
                            }
                        } else {
                            $reg = [Microsoft.Win32.RegistryKey]::OpenRemoteBaseKey('LocalMachine', $dcName)
                            $key = $reg.OpenSubKey('SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint')
                            if ($key) {
                                $restrictDriverInstall = $key.GetValue('RestrictDriverInstallationToAdministrators')
                                if ($restrictDriverInstall -eq 1) {
                                    $pointPrintRestricted = $true
                                }
                                $key.Close()
                            }
                            $reg.Close()
                        }
                    } catch {
                        Write-Verbose "Could not check Point and Print restrictions on $dcName"
                    }

                    # If Point and Print is restricted, vulnerability is mitigated
                    if ($pointPrintRestricted) {
                        $vulnerable = $false
                    }

                    if ($vulnerable) {
                        $findings += [PSCustomObject]@{
                            DomainController          = $dcName
                            OperatingSystem           = $dc.OperatingSystem
                            SpoolerAccessible         = $true
                            PointAndPrintRestricted   = $pointPrintRestricted
                            PrintNightmareVulnerable  = $true
                            CVE                       = 'CVE-2021-34527'
                            CVSS                      = '8.8 (High)'
                            RiskLevel                 = 'Critical'
                            AttackVector              = 'Remote code execution via malicious printer driver'
                            ImmediateAction           = 'Disable Spooler on DCs or apply patches with Point and Print restrictions'
                            DistinguishedName         = $dc.DistinguishedName
                        }
                    }
                }
            } catch {
                Write-Verbose "DLL-VULN-PrintNightmare: Error scanning $dcName - $($_.Exception.Message)"
            }
        }

        return $findings
    }

    Remediation = @{
        Description = 'Disable Print Spooler on DCs or apply patches and configure Point and Print restrictions.'
        Impact      = 'Low - DCs do not need print services.'
        Script      = {
            param($Finding, $Domain)

            @"
##############################################################################
# CRITICAL: PrintNightmare (CVE-2021-34527) Remediation
##############################################################################
#
# PrintNightmare allows remote code execution via malicious printer drivers.
# Domain Controllers should NOT have Print Spooler running.
#
##############################################################################

# OPTION 1: DISABLE PRINT SPOOLER (RECOMMENDED FOR DCs)
# This is the most secure option for Domain Controllers

foreach (`$dc in @($($Finding.Findings.DomainController | ForEach-Object { "'$_'" } -join ', '))) {
    Invoke-Command -ComputerName `$dc -ScriptBlock {
        Stop-Service -Name Spooler -Force
        Set-Service -Name Spooler -StartupType Disabled
        Write-Host "Print Spooler disabled on `$env:COMPUTERNAME"
    }
}

# OPTION 2: APPLY PATCHES AND CONFIGURE RESTRICTIONS
# If Spooler must remain enabled (not recommended on DCs)

# Step 2a: Install the latest security updates
# Check for PrintNightmare patches:
Get-HotFix | Where-Object { `$_.HotFixID -match 'KB5004945|KB5004946|KB5004947|KB5004948|KB5004950|KB5004951|KB5004953|KB5004954|KB5004956|KB5005010' }

# Step 2b: Configure Point and Print Restrictions
# This restricts driver installation to administrators only

# Via Registry:
New-Item -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint' -Force
Set-ItemProperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint' `
    -Name 'RestrictDriverInstallationToAdministrators' -Value 1 -Type DWord
Set-ItemProperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint' `
    -Name 'NoWarningNoElevationOnInstall' -Value 0 -Type DWord
Set-ItemProperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint' `
    -Name 'UpdatePromptSettings' -Value 0 -Type DWord

# Via Group Policy:
# Computer Configuration > Administrative Templates > Printers
# "Point and Print Restrictions"
# Set "When installing drivers for a new connection" = "Show warning and elevation prompt"
# Set "When updating drivers for an existing connection" = "Show warning and elevation prompt"

# Additional hardening:
# "Package Point and Print - Approved servers" = Enabled (with trusted print servers)

# Verify:
Get-ItemProperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint' |
    Select-Object RestrictDriverInstallationToAdministrators, NoWarningNoElevationOnInstall

Get-Service Spooler | Select-Object Status, StartType
"@
        }
    }
}

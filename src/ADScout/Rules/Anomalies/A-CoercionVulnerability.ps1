@{
    Id          = 'A-CoercionVulnerability'
    Version     = '1.0.0'
    Category    = 'Anomalies'
    Title       = 'NTLM Coercion Attack Exposure'
    Description = 'Comprehensive detection of systems vulnerable to NTLM coercion attacks including PetitPotam, PrinterBug, DFSCoerce, and ShadowCoerce. These attacks force victim machines to authenticate to attacker-controlled servers, enabling credential relay for privilege escalation.'
    Severity    = 'Critical'
    Weight      = 45
    DataSource  = 'NetworkSecurity'

    References  = @(
        @{ Title = 'Coerced Authentication Attacks'; Url = 'https://www.thehacker.recipes/ad/movement/mitm-and-coerced-authentications' }
        @{ Title = 'PetitPotam'; Url = 'https://github.com/topotam/PetitPotam' }
        @{ Title = 'Coercer Tool'; Url = 'https://github.com/p0dalirius/Coercer' }
    )

    MITRE = @{
        Tactics    = @('TA0006', 'TA0008')  # Credential Access, Lateral Movement
        Techniques = @('T1187', 'T1557.001')  # Forced Authentication, LLMNR/NBT-NS Poisoning
    }

    CIS   = @('5.5.3')
    STIG  = @('V-220946')
    ANSSI = @('R47')

    Scoring = @{
        Type      = 'TriggerOnPresence'
        PerItem   = 45
    }

    Detect = {
        param($Data, $Domain)

        $findings = @()

        # Coercion methods and their requirements
        $coercionMethods = @(
            @{
                Name = 'MS-RPRN (PrinterBug/SpoolSample)'
                Service = 'Spooler'
                Protocol = 'RPC'
                DefaultEnabled = $true
                Impact = 'Critical'
                CVE = 'Multiple'
            },
            @{
                Name = 'MS-EFSRPC (PetitPotam)'
                Service = 'EFS'
                Protocol = 'RPC'
                DefaultEnabled = $true
                Impact = 'Critical'
                CVE = 'CVE-2021-36942'
            },
            @{
                Name = 'MS-DFSNM (DFSCoerce)'
                Service = 'DFS'
                Protocol = 'RPC'
                DefaultEnabled = $true
                Impact = 'High'
                CVE = 'N/A'
            },
            @{
                Name = 'MS-FSRVP (ShadowCoerce)'
                Service = 'VSS'
                Protocol = 'RPC'
                DefaultEnabled = $true
                Impact = 'High'
                CVE = 'N/A'
            }
        )

        # Check overall exposure
        $smbSigningRequired = $Data.NetworkSecurity.SMBSigningSettings.ServerSigningRequired
        $ldapSigningRequired = $Data.NetworkSecurity.LDAPSigningSettings.LDAPServerSigningRequired

        # If SMB signing is not required, coercion attacks are highly effective
        if (-not $smbSigningRequired) {
            $findings += [PSCustomObject]@{
                Finding             = 'Coercion Attacks Effective - SMB Signing Not Required'
                Description         = 'Without SMB signing, any coercion attack can relay to SMB services'
                VulnerableMethods   = ($coercionMethods | ForEach-Object { $_.Name }) -join ', '
                RiskLevel           = 'Critical'
                AttackChain         = @(
                    '1. Trigger coercion (PetitPotam, PrinterBug, etc.)',
                    '2. Victim authenticates to attacker',
                    '3. Relay to SMB on target (DC, CA, file server)',
                    '4. Execute code or dump secrets'
                ) -join ' -> '
                Mitigation          = 'Enable SMB signing (primary), disable vulnerable services (secondary)'
            }
        }

        if (-not $ldapSigningRequired) {
            $findings += [PSCustomObject]@{
                Finding             = 'Coercion to LDAP Possible - LDAP Signing Not Required'
                Description         = 'Coerced authentication can be relayed to LDAP for AD modification'
                VulnerableMethods   = 'All coercion methods'
                RiskLevel           = 'Critical'
                AttackChain         = @(
                    '1. Trigger coercion against DC',
                    '2. Relay DC auth to another DC LDAP',
                    '3. Add user to Domain Admins',
                    '4. Full domain compromise'
                ) -join ' -> '
                Mitigation          = 'Enable LDAP signing and channel binding'
            }
        }

        # Check for ADCS ESC8 (HTTP enrollment - PetitPotam favorite target)
        if ($Data.CertificateServices) {
            foreach ($ca in $Data.CertificateServices) {
                if ($ca.WebEnrollmentEnabled -and -not $ca.RequireSSL) {
                    $findings += [PSCustomObject]@{
                        Finding             = 'ADCS Web Enrollment - ESC8 (PetitPotam Target)'
                        CAName              = $ca.Name
                        CAServer            = $ca.Server
                        Description         = 'HTTP certificate enrollment allows relaying coerced auth for certificate'
                        RiskLevel           = 'Critical'
                        AttackChain         = @(
                            '1. PetitPotam against DC',
                            '2. Relay to ADCS HTTP enrollment',
                            '3. Request certificate as DC',
                            '4. Authenticate as DC = Domain Admin'
                        ) -join ' -> '
                        Mitigation          = 'Disable HTTP enrollment or require EPA'
                    }
                }
            }
        }

        return $findings
    }

    Remediation = @{
        Description = 'Implement defense-in-depth against coercion attacks: require signing, disable unnecessary services, protect ADCS.'
        Impact      = 'Medium - Multiple changes required across infrastructure'
        Script      = {
            param($Finding, $Domain)

            $commands = @"
# ================================================================
# NTLM COERCION ATTACK MITIGATION
# ================================================================
# Coercion attacks force victims to authenticate to attackers:
# - PetitPotam (MS-EFSRPC)
# - PrinterBug (MS-RPRN)
# - DFSCoerce (MS-DFSNM)
# - ShadowCoerce (MS-FSRVP)
#
# Defense requires MULTIPLE layers!

# ================================================================
# LAYER 1: REQUIRE SIGNING (Most Important)
# ================================================================

# SMB Signing - Blocks relay to SMB
Set-SmbServerConfiguration -RequireSecuritySignature `$true -Force
Set-SmbClientConfiguration -RequireSecuritySignature `$true -Force

# LDAP Signing - Blocks relay to LDAP
# Via GPO or registry on all DCs:
reg add "HKLM\SYSTEM\CurrentControlSet\Services\NTDS\Parameters" /v LDAPServerIntegrity /t REG_DWORD /d 2 /f

# LDAP Channel Binding
reg add "HKLM\SYSTEM\CurrentControlSet\Services\NTDS\Parameters" /v LdapEnforceChannelBinding /t REG_DWORD /d 2 /f

# ================================================================
# LAYER 2: DISABLE VULNERABLE SERVICES ON DCs
# ================================================================

`$DCs = Get-ADDomainController -Filter *
foreach (`$dc in `$DCs) {
    Invoke-Command -ComputerName `$dc.Name -ScriptBlock {
        # Disable Print Spooler
        Stop-Service -Name Spooler -Force -ErrorAction SilentlyContinue
        Set-Service -Name Spooler -StartupType Disabled

        # Disable WebClient
        Stop-Service -Name WebClient -Force -ErrorAction SilentlyContinue
        Set-Service -Name WebClient -StartupType Disabled
    }
}

# ================================================================
# LAYER 3: PROTECT ADCS (If ESC8 Vulnerable)
# ================================================================

# Disable HTTP enrollment (require HTTPS with EPA):
# On CA server:
# certutil -setreg policy\EditFlags -EDITF_ENABLECERTREQUEST_EXTENSION

# Enable EPA on IIS for certificate enrollment:
# Set-WebConfigurationProperty -Filter /system.webServer/security/authentication/windowsAuthentication -Name extendedProtection.tokenChecking -Value Require

# ================================================================
# LAYER 4: PROTECT HIGH-VALUE ACCOUNTS
# ================================================================

# Add sensitive accounts to Protected Users group:
Add-ADGroupMember -Identity "Protected Users" -Members "Administrator", "krbtgt"

# Set "Account is sensitive and cannot be delegated":
Get-ADUser -Filter { AdminCount -eq 1 } | Set-ADAccountControl -AccountNotDelegated `$true

# ================================================================
# LAYER 5: NETWORK SEGMENTATION
# ================================================================

# Block outbound SMB (445) and RPC from DCs to workstations
# Block inbound RPC from untrusted networks to DCs

# ================================================================
# DETECTION: MONITOR FOR COERCION ATTEMPTS
# ================================================================

# Event ID 5145 - File share access (\\*\pipe\spoolss, \\*\pipe\efsrpc)
# Event ID 4624 - Logon from unexpected source
# Network: Watch for SMB/RPC connections from DCs to workstations

"@
            return $commands
        }
    }
}
